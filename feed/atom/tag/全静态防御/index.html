<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"
xmlns:thr="http://purl.org/syndication/thread/1.0"
xml:lang="zh-CN"
xml:base="https://limbopro.xyz/tag/全静态防御/"
>
<title type="text">毒奶博主丨欢迎使用代理访问本站。 - 全静态防御</title>
<subtitle type="text"></subtitle>
<updated>2019-07-18T23:18:00+08:00</updated>
<generator uri="http://typecho.org/" version="1.1/17.10.30">Typecho</generator>
<link rel="alternate" type="text/html" href="../../../../tag/全静态防御/index.html" />
<id>https://limbopro.xyz/feed/atom/tag/%E5%85%A8%E9%9D%99%E6%80%81%E9%98%B2%E5%BE%A1/</id>
<link rel="self" type="application/atom+xml" href="index.html" />
<entry>
<title type="html"><![CDATA[个人博客 DDoS 攻击的防范教程丨低成本&amp;可执行]]></title>
<link rel="alternate" type="text/html" href="../../../../archives/1282.html" />
<id>https://limbopro.xyz/archives/1282.html</id>
<updated>2019-07-18T23:18:00+08:00</updated>
<published>2019-07-18T23:18:00+08:00</published>
<author>
    <name>毒奶</name>
    <uri>https://limbopro.xyz</uri>
</author>
<summary type="html"><![CDATA[本文隶属于网站优化 分类，点击分类名称可以查看更多相关文章；[post cid=&quot;6538&quot; cover=&quot;https://limbopro.xyz/usr/uploads/2019/12/29...]]></summary>
<content type="html" xml:base="https://limbopro.xyz/archives/1282.html" xml:lang="zh-CN"><![CDATA[
<p><img src="../../../../usr/uploads/2019/07/1467826344.jpg" alt="DDoS" title="DDoS"></p><p>本文隶属于<a href="../../../../category/Typecho/index.html">网站优化</a> 分类，点击分类名称可以查看更多相关文章；</p><p>[post cid="6538" cover="https://limbopro.xyz/usr/uploads/2019/12/2912835083.jpg"/]</p><p>做DDoS防御的方法有很多种，但最多的两种莫过于<code>加钱</code>或<code>装死</code>。</p><h2>主理人序</h2><p>加钱，万万是不可能加钱的<br>那就只有装死了<br>静态<del>或伪静态都</del>可以很好的减轻服务器负载，<br>甚至可以说是无敌（几乎；</p><p>静态的情况下再配置<a href="https://cloudflare.com/">cloudflare</a>家的免费CDN以隐藏源站服务器IP<br>大概就可以永久在线了</p><h2>我要变强</h2><p><img src="../../../../usr/uploads/2019/12/1548241171.png" alt="DDoS.png" title="DDoS.png"></p><h3>背景知识</h3><p><strong>快速的全球内容交付网络</strong></p><p>内容分发网络（Content Delivery Network，CDN）通过将站点内容发布至遍布全国的海量加速节点，使其用户可就近获取所需内容，避免网络拥堵、地域、运营商等因素带来的访问延迟问题，有效提升下载速度、降低响应时间，提供流畅的用户体验。</p><p>via <a href="https://cloud.tencent.com/product/cdn">内容分发网络 CDN</a></p><p><strong>静态页面</strong>：<strong>htm、html、shtml、xml</strong></p><p>静态网页是指存放在服务器文件系统中<strong>实实在在的HTML文件</strong>。当用户在浏览器中输入页面的URL，然后回车，浏览器就会将对应的html文件下载、渲染并呈现在窗口中。早期的网站通常都是由静态页面制作的。</p><p><strong>动态页面</strong>：<strong>asp、jsp、php、perl、cgi</strong></p><p>动态网页是相对于静态网页而言的。当浏览器请求服务器的某个页面时，服务器根据当前<strong>时间</strong>、环境<strong>参数</strong>、<strong>数据库</strong>操作等<strong>动态的</strong>生成HTML页面，然后在发送给浏览器（后面的处理就跟静态网页一样了）。很明显，动态网页中的“动态”是指服务器端页面的动态生成，相反，“静态”则指页面是实实在在的、独立的文件。</p><p>via <a href="https://www.jianshu.com/p/649d2a0ebde5">静态网页与动态网页的区别</a></p><p><strong>姿势点小结</strong></p><blockquote><p>静态页面不会涉及<strong>数据库请求</strong>，也无需经过<strong>PHP处理</strong>，<strong>几乎零消耗</strong>；这样的情况下，只需要使用到<strong>nginx</strong>，而nginx的高性能低消耗，想操烂基本不可能（那得多大仇...</p></blockquote><p>*本博客所有.html网页均为伪静态，非真静态；</p><h2>部署CDN</h2><h3>部署免费CDN</h3><p><img src="../../../../usr/uploads/2019/12/2670363509.png" alt="CDN.png" title="CDN.png"></p><p>部署CDN的好处：隐藏源站服务器IP，<a href="https://www.cloudflare.com/zh-cn/cdn/">CDN</a>可以有效节省服务器带宽；</p><p>1.打开<a href="https://cloudflare.com/">cloudflare</a>，注册账号，添加域名，迁移DNS服务商；（英文界面，但很简单...<br>2.使用 <a href="../../../../archives/997.html">censys</a> 检测源站服务器IP是否泄漏；<br>3.如泄漏，请及时更换IP；</p><h3>缓存静态资源概述</h3><p>默认情况下，<a href="https://www.cloudflare.com/features-cdn">Cloudflare CDN</a> 缓存具有以下文件扩展名的文件：</p><table><thead><tr><th>bmp</th><th>ejs</th><th>jpeg</th><th>pdf</th><th>ps</th><th>ttf</th></tr></thead><tbody><tr><td>class</td><td>eot</td><td>jpg</td><td>pict</td><td>svg</td><td>webp</td></tr><tr><td>css</td><td>eps</td><td>js</td><td>pls</td><td>svgz</td><td>woff</td></tr><tr><td>csv</td><td>gif</td><td>mid</td><td>png</td><td>swf</td><td>woff2</td></tr><tr><td>doc</td><td>ico</td><td>midi</td><td>ppt</td><td>tif</td><td>xls</td></tr><tr><td>docx</td><td>jar</td><td>otf</td><td>pptx</td><td>tiff</td><td>xlsx</td></tr></tbody></table><p>以上，不在范围内的就不会缓存了。参考：<a href="https://www.cloudflare.com/zh-cn/features-page-rules/must-use-page-rules/">必用的基本页面规则</a>，在Cloudflare中设置你想要缓存的页面或者目录，注意，这个参考非常重要。</p><p>*Cloudflare 仅缓存从您网站直接提供的资源。第三方资源（Facebook、Flickr 等）不会被缓存。Cloudflare 当前不会按 MIME 类型进行缓存。</p><h2>静态镜像</h2><h3>制作静态镜像</h3><pre><code>wget --mirror -t 2 -S -N -k https://limbopro.xyz -P /home/wwwroot/public/</code></pre><p>1.使用wget命令，下载一份网站的镜像（网站上公开的所有内容...<br>2.得到一份<strong>静态镜像</strong>（里面有html/jpg/...；<br>3.其中的参数<code>-k</code>为将链接转化为本地路径；<br>4.其中的参数<code>-P</code>为备份保存路径，届时会自动创建文件夹，文件名字将以网站名字命名；<br>5.最终得到 /home/wwwroot/public/limbopro.xyz；</p><h3>使用静态镜像</h3><p>1.前面已经说了，通过<strong>mysql/php</strong>动态生成网页会消耗服务器大量性能资源；<br>2.攻击者通过大量请求把服务器性能消耗完毕，以使网站瘫痪；<br>3.攻击者用的方法有很多，可参考 <a href="https://t.me/limboprossr/1128">https://t.me/limboprossr/1128</a></p><p>修改<strong>nginx配置路径</strong>以使用<strong>静态镜像</strong>；</p><pre><code>index index.html index.htm index.php default.html default.htm default.php index.log main.html;
root /home/wwwroot/pubilc/;</code></pre><p>以上，正常配置时的路径/home/wwwroot/public/；</p><pre><code>index index.html index.htm index.php default.html default.htm default.php index.log main.html;
root /home/wwwroot/public/limbopro.xyz;</code></pre><p>修改配置到备份文件夹，修改后重启 nginx 即可；</p><h3>动静态切换的适用类型</h3><p>1.<strong>个人博客</strong>可以使用此方法，只需实现文章的排版展示即可（CSS搭配HTML即可轻松实现；<br>2.<strong>论坛，社区</strong>不可用（因为这些地方需要交互，需要大量调用数据库，PHP等，静态网页是肯定不行的；</p><h3>自动切换静态镜像脚本</h3><p>1.使用crontab自动执行脚本：CPUcheck.sh & 100cpu.sh；<br>2.3分钟内有两次高负载则自动切换静态；<br>3.脚本中涉及<code>ps</code>/<code>grep</code>以及<code>if</code>的应用<br>4.较为通俗易懂，<br>5.仅供参考；</p><p><strong>/home/100cpu.sh</strong> </p><p>该脚本用于检查每分钟的CPU负载情况，达到阈值(比如CPU使用率达到80%)则记录至/home/100cpu.log；</p><pre><code>#!/bin/bash
##CPU判定

function GetSysCPU 
 {
   CpuIdle=`vmstat 1 5 |sed -n '3,$p' | awk '{x = x + $15} END {print x/5}' | awk -F. '{print $1}'` 
   CpuNum=`echo &quot;100-$CpuIdle&quot; | bc` 
   echo $CpuNum 
 }
 
   usage=`GetSysCPU` 
   max=80 #CPU阈值，超过则记录至100cpu.log
   
if [ ${usage} -ge $max ];
then
date=$(env LANG=en_US.UTF-8 date &quot;+%e/%b/%Y/%R&quot;)
echo &quot;$date，CPU负载为$usage...&quot; &gt;&gt; /home/100cpu.log
else 

date=$(env LANG=en_US.UTF-8 date &quot;+%e/%b/%Y/%R&quot;)
##echo &quot;$date，CPU负载为$usage%...&quot; &gt;&gt; /home/100cpu.log
echo &quot;${date}&quot; &quot;CPU负载正常...&quot;

fi</code></pre><p><strong>/home/CPUcheck.sh</strong></p><p>该脚本用于统计 /home/100cpu.log 的记录值，统计一定时间范围（本示例是3分钟）内CPU负载超标次数，本示例中超标次数超过2次则切换使用静态镜像，并关闭<strong>MySQL/PHP</strong>；</p><pre><code>#!/bin/bash

##判定层
ps -fe|grep &quot;wget&quot; |grep -v grep
if [ $? -ne 0 ]
#判定层

then

##执行层
&gt; /home/100cpu.statistics.log; ##清空记录
wc -l /home/100cpu.log &gt;&gt; /home/100cpu.statistics.log #记录
results=$(awk '{print $1}' /home/100cpu.statistics.log) #记录
&gt; /home/100cpu.log; #清空记录
max=2 #触发阈值为2次

if [ $results -ge $max  ];
then
   /home/switch2static.sh; #非备份情况下超过阈值则触发静态
else
date=$(env LANG=en_US.UTF-8 date &quot;+%e/%b/%Y/%R&quot;)
/home/sec.ddoscheck.normal.sh; #切换至正常状态
echo &quot;${date}&quot; &quot;已切换至正常模式...&quot; &gt;&gt; /home/nglog.log; #记录操作日志
fi

##执行层

else
#Wget正在备份
date=$(env LANG=en_US.UTF-8 date &quot;+%e/%b/%Y/%R&quot;)
echo &quot;${date}&quot; &quot;CPU高，主要是因为在备份...&quot; &gt;&gt; /home/nglog.log; #记录操作日志
fi</code></pre><p><strong>/home/switch2static.sh</strong></p><p>该脚本用于切换 nginx 配置文件，并加载配置使之生效；其中 .conf.ddos 的配置方法可参考本文 <strong>使用静态镜像</strong> 一节；</p><pre><code>#!/bin/bash
date=$(env LANG=en_US.UTF-8 date &quot;+%e/%b/%Y/%R&quot;)
echo &quot;${date}&quot; &quot;已进入静态防御模式...&quot; &gt;&gt; /home/nglog.log; #记录操作日志
cp /usr/local/nginx/conf/vhost/limbopro.xyz.conf.ddos  /usr/local/nginx/conf/vhost/limbopro.xyz.conf; #博客切至静态配置
lnmp nginx reload #reload 配置使生效
#killall mysql; #关闭数据库
lnmp mysql stop;
lnmp php-fpm stop;
#killall php-ftm; #关闭php</code></pre><p><strong>/home/sec.ddoscheck.normal.sh</strong></p><p>该脚本用于切换 nginx 配置文件 至正常状态；</p><pre><code>/bin/cp /usr/local/nginx/conf/vhost/limbopro.xyz.conf.bak  /usr/local/nginx/conf/vhost/limbopro.xyz.conf #limbopro.xyz.conf.bak为正常nginx配置备份
lnmp nginx reload;
/bin/bash /home/autorestart.sh #检测MySQL/PHP状态并重启</code></pre><p><strong>/home/autorestart.sh</strong></p><p>该脚本用于检测并重启 <code>MySQL/PHP</code>；</p><pre><code>#!/bin/bash

#mysql 检测重启
/bin/ps -ef | grep mysql |grep -v grep &gt; /dev/null
if [ $? != 0 ];then
lnmp mysql restart &gt; /dev/nullf
fi

#php-fpm 检测重启
/bin/ps -ef | grep php-fpm.conf |grep -v grep &gt; /dev/null
if [ $? != 0 ];then
lnmp php-fpm restart &gt; /dev/nullf
fi</code></pre><p><strong>使用crontab自动执行脚本</strong></p><p>最后一步，使CPUcheck.sh/100cpu.sh脚本的执行自动化，其中的参数可根据需要自行修改；</p><pre><code>root@localhost:/home#  crontab -e
*/3 * * * * /home/CPUcheck.sh #每3分钟检测是否超过阈值
*/1 * * * * /home/100cpu.sh #每分钟记录一次CPU值</code></pre><p>Crontab的使用可参考<a href="https://www.runoob.com/linux/linux-comm-crontab.html">Linux crontab 命令</a>；</p><h2>其他</h2><p>无。</p><h2>总结</h2><p>以最小的成本应对攻击，并保持网页链接打开完好完整（损失更新文章特性），我觉得这仍然不失为一个不错的策略。博主仍在努力学习相关知识，也希望本篇文章能给大家带来帮助。</p><h2>联系主理人</h2><p>1.关注频道 <a href="https://t.me/limboprossr">https://t.me/limboprossr</a> 不失联；<br>2.<code>毒奶粉</code>们（我管我的Fans）可联系 <a href="../../../../usr/uploads/2019/10/3453243330.png">TG机器人</a> 或发送 <a href="../../../../usr/uploads/2019/10/3453243330.png">邮件</a> 获取帮助；</p><p>3.或点击<code>本页面右下角</code>的聊天按钮联系；</p><h2>参考与附录</h2><p>1.<a href="http://www.724idc.com/helpview_71.html">DDoS防御的11种方针详解</a></p>
]]></content>
<link rel="replies" type="text/html" href="../../../../archives/1282.html#comments" thr:count="0" />
<link rel="replies" type="application/atom+xml" href="../../archives/1282.html" thr:count="0"/>
</entry>
</feed>